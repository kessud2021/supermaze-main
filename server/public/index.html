<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SuperMaze - Multiplayer</title>
<style>
/* --- STYLES --- */
body { margin:0; font-family:'Segoe UI',Roboto,sans-serif; background:#1a1a2e; color:#fff; display:flex; justify-content:center; padding:20px; }
.glass { background:rgba(255,255,255,0.05); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1); border-radius:15px; padding:20px; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.5); width:100%; max-width:800px; margin-bottom: 20px;}
.screen { display:none; flex-direction:column; align-items:center; width:100%; }
.screen.active { display:flex; }
button { padding:10px 20px; margin:5px; border-radius:8px; border:none; cursor:pointer; font-weight:bold; background:#6c63ff; color:white; transition:0.2s; }
button:hover { transform:translateY(-2px); }
button.secondary { background:#444; }
input { padding:10px; margin:5px; border-radius:5px; border:none; background:rgba(0,0,0,0.3); color:white; }

/* Grid Styles */
#maze-container, #maze-container-play { display:grid; gap:1px; background:rgba(255,255,255,0.1); padding:2px; border-radius:5px; margin-top:10px; position: relative;}
.cell { width:25px; height:25px; background:rgba(255,255,255,0.05); border-radius:3px; cursor:pointer; }
.cell.wall { background:#ff4757; }
.cell.start { background:#2ed573; }
.cell.end { background:#3742fa; }
.cell.teleporter { background:#ffa502; border:2px solid #fff; }

/* Player Avatars */
.player-sprite { width:21px; height:21px; background:#f1c40f; border-radius:50%; position:absolute; transition: all 0.1s linear; z-index: 10; margin: 2px; box-shadow: 0 0 5px yellow;}
.other-player { background:#00d2d3; box-shadow: 0 0 5px cyan; z-index: 5;}
.nametag { position:absolute; top:-15px; left:-10px; font-size:10px; white-space:nowrap; background:rgba(0,0,0,0.5); padding:1px 4px; border-radius:4px; pointer-events: none; }
</style>
</head>
<body>

<div id="home" class="glass screen active">
  <h1>üåÄ SuperMaze Multiplayer</h1>
  <div id="auth-ui">
    <input type="text" id="username-input" placeholder="Username">
    <button onclick="login()">Login</button>
  </div>
  <div id="main-menu" style="display:none;">
    <h3>Welcome, <span id="display-name"></span></h3>
    <button onclick="showScreen('play-screen'); startMultiplayer('hub')">üåç Play Online</button>
    <button onclick="openEditorAuth()">üõ†Ô∏è Map Editor</button>
    <button onclick="loadMarketplace()">üõí Marketplace</button>
  </div>
</div>

<div id="editor-auth" class="glass screen" style="max-width:400px;">
  <h2>üîê Editor Password</h2>
  <input type="password" id="editor-password" placeholder="Editor Password">
  <button onclick="authEditor()">Unlock</button>
  <button class="secondary" onclick="showScreen('home')">Cancel</button>
</div>

<div id="editor" class="glass screen">
  <h2>üõ†Ô∏è Map Editor</h2>
  <div>
    <input type="text" id="map-name" placeholder="World Name (e.g. hub)">
    <input type="number" id="grid-size" value="15" style="width:50px">
    <button onclick="createEditorGrid()">New</button>
    <button onclick="saveMap()">üíæ Save</button>
    <button class="secondary" onclick="showScreen('home')">Exit</button>
  </div>
  <div style="margin:10px;">
    <button onclick="tool='wall'">üß± Wall</button>
    <button onclick="tool='start'">üö© Start</button>
    <button onclick="tool='end'">üèÅ End</button>
    <button onclick="tool='teleporter'">üåå Teleporter</button>
    <button onclick="tool='eraser'">üßΩ Eraser</button>
  </div>
  <div id="maze-container"></div>
</div>

<div id="play-screen" class="glass screen">
  <h2 id="world-title">Loading World...</h2>
  <div id="maze-container-play" style="position: relative;"></div>
  <button class="secondary" onclick="leaveGame()">Disconnect</button>
</div>

<div id="marketplace" class="glass screen">
  <h2>üõí World Browser</h2>
  <div id="map-list">Loading...</div>
  <button class="secondary" onclick="showScreen('home')">Back</button>
</div>

<script>
// --- STATE ---
let username = null;
let editorToken = null;
let ws = null;
let tool = 'wall';
let editorData = []; 
let gridSize = 15;
let currentGameMap = []; // The map data for the active game
let myPos = {x:1, y:1};

const showScreen = (id) => {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
};

// --- AUTH ---
async function login() {
  const name = document.getElementById('username-input').value.trim();
  if(!name) return alert("Enter name");
  const res = await fetch('/api/auth', { 
    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:name})
  });
  const data = await res.json();
  if(data.success) {
    username = name;
    document.getElementById('auth-ui').style.display='none';
    document.getElementById('main-menu').style.display='block';
    document.getElementById('display-name').innerText = name;
  }
}

async function openEditorAuth() {
  showScreen('editor-auth');
  document.getElementById('editor-password').value = '';
  document.getElementById('editor-password').focus();
}

async function authEditor() {
  const password = document.getElementById('editor-password').value.trim();
  if(!password) return alert("Enter password");
  const res = await fetch('/api/editor/auth', { 
    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password})
  });
  const data = await res.json();
  if(data.success) {
    editorToken = "editor_authed";
    showScreen('editor');
  } else {
    alert(data.error || "Wrong password");
  }
}

// --- EDITOR ---
function createEditorGrid() {
  gridSize = parseInt(document.getElementById('grid-size').value);
  editorData = Array(gridSize).fill().map(() => Array(gridSize).fill(0)); // 0=empty
  renderEditor();
}

function renderEditor() {
  const c = document.getElementById('maze-container');
  c.innerHTML = '';
  c.style.gridTemplateColumns = `repeat(${gridSize}, 25px)`;
  
  for(let y=0; y<gridSize; y++) {
    for(let x=0; x<gridSize; x++) {
      const d = document.createElement('div');
      d.className = 'cell';
      const val = editorData[y][x];
      
      // Visuals
      if(val === 1) d.classList.add('wall');
      if(val === 2) d.classList.add('start');
      if(val === 3) d.classList.add('end');
      if(typeof val === 'object' && val.type === 4) d.classList.add('teleporter');

      d.onmousedown = () => {
        if(tool === 'wall') editorData[y][x] = 1;
        else if(tool === 'start') editorData[y][x] = 2;
        else if(tool === 'end') editorData[y][x] = 3;
        else if(tool === 'eraser') editorData[y][x] = 0;
        else if(tool === 'teleporter') {
            const dest = prompt("Destination World Name:");
            if(dest) editorData[y][x] = { type: 4, target: dest };
        }
        renderEditor(); // Re-render to show changes
      };
      c.appendChild(d);
    }
  }
}

async function saveMap() {
  if(!editorToken) return alert("Please unlock editor first");
  const name = document.getElementById('map-name').value || 'untitled';
  const res = await fetch('/api/worlds', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ name, data: { size: gridSize, grid: editorData }, editorToken })
  });
  const data = await res.json();
  if(data.success) {
    alert("Saved!");
  } else {
    alert(data.error || "Save failed");
  }
}

// --- MULTIPLAYER GAME ---
function startMultiplayer(world) {
  if(ws) ws.close();
  ws = new WebSocket(window.location.origin.replace(/^http/, 'ws'));
  
  ws.onopen = () => {
    ws.send(JSON.stringify({ type: 'join', username }));
  };

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);

    // 1. RECEIVE MAP DATA
    if(msg.type === 'map_data') {
        loadGameMap(msg.world, msg.data);
    }

    // 2. RECEIVE PLAYER POSITIONS
    if(msg.type === 'world_update') {
        updatePlayers(msg.players);
    }
  };
}

function loadGameMap(worldName, mapData) {
    document.getElementById('world-title').innerText = "World: " + worldName;
    const c = document.getElementById('maze-container-play');
    c.innerHTML = '';
    
    const size = mapData.size;
    currentGameMap = mapData.grid; // Store for collision logic
    
    // Set Grid CSS
    c.style.width = (size * 27) + "px"; // 25px cell + 2px gap approx
    c.style.height = (size * 27) + "px";
    c.style.gridTemplateColumns = `repeat(${size}, 25px)`;
    c.style.gap = "2px";

    // Render Tiles
    for(let y=0; y<size; y++) {
        for(let x=0; x<size; x++) {
            const d = document.createElement('div');
            d.className = 'cell';
            const val = currentGameMap[y][x];
            
            if(val === 1) d.classList.add('wall');
            if(val === 2) { d.classList.add('start'); myPos = {x, y}; } // Auto spawn at start
            if(val === 3) d.classList.add('end');
            if(typeof val === 'object' && val.type === 4) d.classList.add('teleporter');
            
            c.appendChild(d);
        }
    }
    
    // Create My Player
    const p = document.createElement('div');
    p.id = 'my-player';
    p.className = 'player-sprite';
    p.innerHTML = `<div class="nametag">${username}</div>`;
    c.appendChild(p);
    updateMyPos();
}

function updatePlayers(players) {
    const c = document.getElementById('maze-container-play');
    
    // Remove old ghosts
    document.querySelectorAll('.other-player').forEach(el => el.remove());

    Object.keys(players).forEach(key => {
        const p = players[key];
        if(p.username === username) return; // Skip me

        const ghost = document.createElement('div');
        ghost.className = 'player-sprite other-player';
        ghost.style.left = (p.x * 27) + 'px'; // 25px + 2px gap
        ghost.style.top = (p.y * 27) + 'px';
        ghost.innerHTML = `<div class="nametag">${p.username}</div>`;
        c.appendChild(ghost);
    });
}

function updateMyPos() {
    const p = document.getElementById('my-player');
    if(p) {
        p.style.left = (myPos.x * 27) + 'px';
        p.style.top = (myPos.y * 27) + 'px';
    }
    // Send to server
    if(ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type:'move', x: myPos.x, y: myPos.y }));
    }
}

// Controls
window.onkeydown = (e) => {
    if(!currentGameMap.length) return;
    
    let nx = myPos.x;
    let ny = myPos.y;

    if(e.key === 'w' || e.key === 'ArrowUp') ny--;
    if(e.key === 's' || e.key === 'ArrowDown') ny++;
    if(e.key === 'a' || e.key === 'ArrowLeft') nx--;
    if(e.key === 'd' || e.key === 'ArrowRight') nx++;

    // Collision Check
    const tile = currentGameMap[ny] && currentGameMap[ny][nx];
    
    // 1. Wall Check
    if(tile !== undefined && tile !== 1) {
        myPos.x = nx;
        myPos.y = ny;
        updateMyPos();

        // 2. Teleport Check
        if(typeof tile === 'object' && tile.type === 4) {
            ws.send(JSON.stringify({ type: 'teleport', toWorld: tile.target }));
        }
    }
};

function leaveGame() {
    if(ws) ws.close();
    showScreen('home');
}

// --- MARKETPLACE ---
async function loadMarketplace() {
    showScreen('marketplace');
    const res = await fetch('/api/worlds');
    const list = await res.json();
    const c = document.getElementById('map-list');
    c.innerHTML = '';
    list.forEach(name => {
        c.innerHTML += `<div class="map-card" style="background:#333; padding:10px; margin-bottom:5px; border-radius:5px; display:flex; justify-content:space-between;">
            <span>${name}</span>
            <button onclick="startMultiplayer('${name}'); showScreen('play-screen')">Play</button>
        </div>`;
    });
}

// Init
createEditorGrid();
</script>
</body>
</html>
